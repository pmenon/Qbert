package net.qbert.network

import scala.collection.mutable
import org.jboss.netty.buffer.{ChannelBuffer, ChannelBuffers}

class FrameReader(buf: ChannelBuffer) {
  def readBytes(b: Array[Byte]): Unit = buf.readBytes(b)
  def readBytes(len: Int): Array[Byte] = {
    val buf = Array.ofDim[Byte](len)
    readBytes(buf)
    buf
  }

  def readOctet(): Int = buf.readUnsignedByte
  def readShort(): Int = buf.readUnsignedShort
  def readLong(): Int = buf.readInt
  def readLongLong(): Long = buf.readLong
  def readFloat(): Float = buf.readFloat
  def readTimestamp(): Long = buf.readLong

  def readArray(): Array[Any] = {
    val len = readInt
    val arr = mutable.ArrayBuffer[Any](len)

    1 to len foreach( i => arr += readFieldValue)
    
    Array[Any]() ++ arr
  }

  def readFieldValue(): Any = {
    readOctet match {
      case 'A' => readArray
      case 'T' => readTimestamp
      case 't' => readOctet
      case 'U' => readShort
      case 'F' => readFieldTable
      case 'I' => readLong
      case 'l' => readLongLong
      case 's' => readShortString
      case 'S' => readLongString
      case _ => println("value type not found"); readOctet
    }
  }

  def readFieldTable(): Map[String, Any] = {
    val res = mutable.Map[String, Any]()
    val s = readLong
    val tableFR = new FrameReader(buf.readBytes(s))

    while(tableFR.readableBytes > 0) res.put(tableFR.readShortString, tableFR.readFieldValue)

    Map[String, Any]() ++ res
  }

  def readShortString(): String = {
    val len = readOctet
    val s = new String( readBytes(len), "utf-8" )
    s
  }

  def readLongString(): String = {
    val len = readLong
    val m = new String( readBytes(len), "utf-8" )
    m
  }

  def readableBytes = buf.readableBytes
}
